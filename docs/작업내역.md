# 가족 트리 웹 애플리케이션 작업 내역

## 📅 작업 일시
**2025년 11월 28일**

---

## 📋 프로젝트 개요

가족 구성원을 관리하고 세대별 가계도를 시각화하는 웹 애플리케이션 개발

### 기술 스택
- **Backend**: Node.js, Express.js
- **Database**: SQLite3 (better-sqlite3)
- **Frontend**: HTML5, CSS3, Vanilla JavaScript
- **패키지 관리**: npm

---

## ✅ 완료된 작업

### 1. 초기 설정 및 프로젝트 구조

#### 1.1 Telegram 조건부 로그 작성
- `.cursor/rules/after_each_chat.mdc` 수정
- Telegram을 통한 문의일 때만 summary log 생성
- `tmp/summary-YYYYMMDD-HHmmss.json` 형식으로 저장

#### 1.2 프로젝트 설계 문서 작성
- `DESIGN.md` 작성
- Person 데이터 모델 설계
- RESTful API 엔드포인트 설계
- MySQL vs SQLite3 비교 후 SQLite3 선정

---

### 2. 데이터베이스 설계 및 구현

#### 2.1 스키마 설계
```sql
-- persons 테이블
CREATE TABLE persons (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  gender TEXT CHECK(gender IN ('male', 'female', 'other')),
  birth_date TEXT,
  death_date TEXT,
  phone_number TEXT,
  email TEXT,
  address TEXT,
  occupation TEXT,
  photo TEXT,
  is_alive INTEGER DEFAULT 1,
  father_id INTEGER,
  mother_id INTEGER,
  spouse_id INTEGER,
  generation INTEGER DEFAULT 1,
  notes TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- relationships 테이블
CREATE TABLE relationships (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  person_id INTEGER NOT NULL,
  related_person_id INTEGER NOT NULL,
  relationship_type TEXT NOT NULL,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2 샘플 데이터 생성
- 4세대 16명의 가족 구성원 데이터
- 1세대: 김대호, 최영숙 부부
- 2세대: 김일중, 김일수 (형제) + 배우자
- 3세대: 김철수, 김철민, 김미영, 김준호, 김수진 등
- 4세대: 김민수, 김지은, 김서연, 김하준

#### 2.3 데이터 일관성 개선
- 1세대의 자녀가 2세대가 되도록 구조 개선
- 각 세대 간 부모-자식 관계 정확히 설정
- 배우자 관계 양방향 설정

---

### 3. Backend API 구현

#### 3.1 서버 설정 (`server.js`)
- Express 서버 구성
- 정적 파일 서빙 (public, uploads)
- Morgan 로깅 (정적 파일 요청 필터링)
- CORS 및 JSON 파싱 설정

#### 3.2 모델 구현
**Database.js**
- SQLite 데이터베이스 초기화
- 테이블 생성 및 인덱스 설정
- 샘플 데이터 삽입 함수

**Person.js**
- CRUD 작업: create, getById, getAll, update, delete
- getFamilyById: 가족 관계 조회
- getStats: 통계 정보
- search: 검색 기능

**Relationship.js**
- create, getByPersonId, delete
- 관계 관리 기능

#### 3.3 API 라우트
**persons.js**
- `GET /api/persons` - 전체 목록
- `GET /api/persons/:id` - 상세 정보
- `POST /api/persons` - 생성
- `PUT /api/persons/:id` - 수정
- `DELETE /api/persons/:id` - 삭제
- `GET /api/persons/:id/family` - 가족 정보
- `GET /api/persons/stats` - 통계

**relations.js**
- `POST /api/relations` - 관계 생성
- `DELETE /api/relations/:id` - 관계 삭제

**tree.js**
- `GET /api/tree` - 전체 가계도
- `GET /api/tree/:rootId` - 특정 인물 중심 가계도

**upload.js**
- `POST /api/upload/photo` - 사진 업로드

---

### 4. Frontend 구현

#### 4.1 HTML 구조 (`public/index.html`)
- 대시보드 섹션
- 사람 목록 섹션
- 가계도 시각화 섹션
- 새 가족 추가 폼
- 상세 정보 모달

#### 4.2 스타일링
**style.css**
- 모던하고 반응형 디자인
- CSS 변수를 활용한 테마 시스템
- 카드 레이아웃, 버튼, 폼 스타일

**tree.css**
- 가계도 전용 스타일
- SVG 연결선 스타일
- 세대별 레이아웃
- 부부, 자녀 관계 시각화
- 반응형 디자인 (데스크톱, 태블릿, 모바일)

#### 4.3 JavaScript 로직 (`public/js/main.js`)
**핵심 기능:**
1. **대시보드**
   - 통계 표시 (총 인원, 생존/고인, 세대)
   - 최근 등록된 인물 표시

2. **사람 목록**
   - 전체 목록 표시
   - 검색 기능
   - 세대별 필터링
   - 상세 정보 모달

3. **가계도 시각화**
   - 재귀적 트리 렌더링
   - 부부 단위 그룹화
   - 자녀 연결선 표시
   - 중복 인물 방지 (rendered Set 사용)
   - 자녀 유무에 따른 조건부 선 표시

4. **폼 관리**
   - 새 가족 추가
   - 정보 수정
   - 유효성 검사

**주요 함수:**
- `buildFamilyTree()`: 전체 가계도 구축
- `renderCoupleAndChildren()`: 부부와 자녀 재귀 렌더링
- `groupCouples()`: 부부 단위 그룹화
- `createPersonNodeHTML()`: 인물 노드 생성
- `getDefaultAvatar()`: 성별별 기본 아바타 생성
- `handleImageError()`: 이미지 로딩 오류 처리

#### 4.4 API 통신 (`public/js/api.js`)
- Fetch API를 사용한 RESTful 통신
- PersonAPI, RelationshipAPI, TreeAPI, UploadAPI 모듈화

---

### 5. 가계도 시각화 개선

#### 5.1 중복 제거
**문제:** 김철수가 여러 번 표시됨
**해결:** 
- `rendered` Set을 사용하여 이미 표시된 인물 추적
- 각 인물을 한 번만 렌더링

#### 5.2 부부 관계 표시
- 부부를 가로로 배치
- 수평선으로 연결
- Gap 30px 유지

#### 5.3 자녀 연결 개선
**여러 자녀:**
- 부모에서 수직선 하강
- 자녀들을 연결하는 수평선
- 각 자녀로 분기하는 수직선

**한 명의 자녀:**
- 부모에서 직접 수직선 연결
- 불필요한 수평선 제거

#### 5.4 조건부 선 표시
**문제:** 자녀가 없는 사람(김철민, 김미영, 김수진)도 하단에 선이 표시됨
**해결:**
- 자녀 유무를 먼저 확인
- `has-children` 또는 `no-children` 클래스 추가
- CSS로 조건부 스타일 적용
- `bottom: -50px`로 정확한 위치 조정

```javascript
// 자녀 찾기 (먼저 확인)
const parentIds = [husband?.id, wife?.id].filter(id => id);
const children = allPeople.filter(p => 
  parentIds.includes(p.father_id) || parentIds.includes(p.mother_id)
);
const hasChildren = children.length > 0;

// 부부 렌더링 (자녀 유무에 따라 클래스 추가)
html += `<div class="couple ${hasChildren ? 'has-children' : 'no-children'}">`;
```

```css
/* 자녀가 있을 때만 하단 선 표시 */
.couple.has-children::before {
  content: '';
  position: absolute;
  bottom: -50px;
  left: 50%;
  transform: translateX(-50%);
  width: 3px;
  height: 50px;
  background: var(--primary-color);
}

/* 자녀가 없을 때 선 제거 */
.couple.no-children::before {
  display: none;
}
```

---

### 6. 로그 및 디버깅 개선

#### 6.1 정적 파일 로그 필터링
**문제:** `/images/default-avatar.png` 요청이 로그를 가득 채움
**해결:**
```javascript
// server.js
app.use(morgan((tokens, req, res) => {
  // 정적 파일 요청은 로그에서 제외
  if (req.url.startsWith('/uploads') || 
      req.url.startsWith('/images') || 
      req.url.startsWith('/css') || 
      req.url.startsWith('/js')) {
    return null;
  }
  return [
    new Date().toISOString() + ' -',
    tokens.method(req, res),
    tokens.url(req, res)
  ].join(' ');
}));
```

#### 6.2 이미지 로딩 무한 루프 방지
**문제:** 이미지 로딩 실패 시 무한 루프
**해결:**
```javascript
function handleImageError(imgElement, gender) {
  if (imgElement.dataset.errorHandled) return;
  imgElement.dataset.errorHandled = 'true';
  imgElement.src = getDefaultAvatar(gender);
}
```

#### 6.3 데이터베이스 구조 확인 스크립트
- `check-db.js` 생성
- 세대별 가족 구성 출력
- 관계 검증 로직 추가

---

### 7. 모바일 접근 설정

#### 7.1 로컬 네트워크 IP 확인
```bash
ipconfig | findstr /i "IPv4"
# 결과: 192.168.45.46
```

#### 7.2 모바일 접속 주소
```
http://192.168.45.46:3000
```

#### 7.3 필요 조건
- PC와 모바일이 같은 WiFi 네트워크에 연결
- Windows 방화벽에서 3000 포트 허용 필요 (필요시)

---

## 📁 프로젝트 구조

```
familyTree/
├── server.js                 # Express 서버 진입점
├── package.json              # 프로젝트 의존성
├── .gitignore               # Git 무시 파일
├── README.md                # 프로젝트 소개
├── DESIGN.md                # 설계 문서
├── CHANGELOG.md             # 변경 이력
├── GETTING_STARTED.md       # 시작 가이드
├── TROUBLESHOOTING.md       # 문제 해결 가이드
├── docs/                    # 문서 폴더
│   └── 작업내역.md          # 작업 내역 (본 문서)
├── src/
│   ├── models/
│   │   ├── Database.js      # DB 초기화 및 스키마
│   │   ├── Person.js        # Person 모델
│   │   └── Relationship.js  # Relationship 모델
│   └── routes/
│       ├── persons.js       # 사람 API
│       ├── relations.js     # 관계 API
│       ├── tree.js          # 가계도 API
│       └── upload.js        # 업로드 API
├── public/
│   ├── index.html           # 메인 페이지
│   ├── css/
│   │   ├── style.css        # 일반 스타일
│   │   └── tree.css         # 가계도 스타일
│   └── js/
│       ├── api.js           # API 통신
│       └── main.js          # 메인 로직
├── data/
│   └── familytree.db        # SQLite 데이터베이스
├── uploads/                 # 업로드된 사진
│   └── .gitkeep
└── tmp/                     # 임시 파일 (summary logs)
```

---

## 🎯 주요 기능

### 1. 대시보드
- 📊 실시간 통계 (총 인원, 생존/고인, 세대 수)
- 👥 최근 등록된 가족 구성원 표시

### 2. 사람 관리
- ➕ 새 가족 구성원 추가
- ✏️ 정보 수정
- 🗑️ 삭제
- 🔍 이름, 전화번호로 검색
- 🔢 세대별 필터링

### 3. 가계도 시각화
- 🌳 4세대 가계도 표시
- 👫 부부 관계 시각화
- 👶 부모-자녀 관계 연결선
- 🔄 재귀적 트리 구조
- 📱 반응형 디자인

### 4. 상세 정보
- 👤 개인 정보 표시
- 👨‍👩‍👧‍👦 가족 관계 (부모, 배우자, 자녀)
- 📝 메모 관리

---

## 🐛 해결된 주요 이슈

### Issue #1: 김철수 중복 표시
- **원인**: 재귀 렌더링 시 중복 체크 부족
- **해결**: `rendered` Set으로 추적

### Issue #2: 이미지 로딩 무한 루프
- **원인**: `onerror` 핸들러가 반복 호출됨
- **해결**: `data-errorHandled` 플래그 사용

### Issue #3: 로그 스팸
- **원인**: 정적 파일 요청이 모두 로깅됨
- **해결**: Morgan 필터링 커스터마이징

### Issue #4: 자녀 없는 경우 불필요한 선 표시
- **원인**: CSS에서 자녀 유무를 구분하지 못함
- **해결**: JavaScript에서 `has-children` / `no-children` 클래스 동적 추가

### Issue #5: 세대 간 데이터 일관성
- **원인**: 1세대의 자녀가 2세대와 분리됨
- **해결**: 샘플 데이터 재구성으로 정확한 부모-자식 관계 설정

---

## 📝 NPM 스크립트

```json
{
  "start": "node server.js",
  "dev": "nodemon server.js",
  "init-db-sample": "node src/models/Database.js --sample"
}
```

### 사용법
```bash
# 샘플 데이터로 DB 초기화
npm run init-db-sample

# 개발 모드 실행 (자동 재시작)
npm run dev

# 프로덕션 모드 실행
npm start
```

---

## 🔧 기술적 결정 사항

### SQLite3 vs MySQL
**SQLite3 선택 이유:**
1. ✅ 서버리스 - 별도 DB 서버 불필요
2. ✅ 파일 기반 - 쉬운 백업 및 이동
3. ✅ 경량화 - 작은 프로젝트에 적합
4. ✅ ACID 트랜잭션 지원
5. ✅ 복잡한 관계 쿼리 가능
6. ✅ 쉬운 배포 - 단일 파일

### 가계도 렌더링 방식
**재귀 렌더링 선택 이유:**
1. ✅ 무한 깊이 지원
2. ✅ 코드 간결성
3. ✅ 동적 확장 가능
4. ✅ 부모-자식 관계 자연스럽게 표현

### CSS 연결선 vs SVG
**CSS 선택 이유:**
1. ✅ 간단한 구현
2. ✅ 반응형 대응 용이
3. ✅ 성능 우수
4. ❌ 복잡한 곡선은 어려움 (현재 프로젝트에는 불필요)

---

## 🚀 향후 개선 사항

### 1. 기능 추가
- [ ] 사진 업로드 기능 완성
- [ ] 관계 추가/편집 UI
- [ ] 가계도 확대/축소 기능
- [ ] 가계도 인쇄/PDF 내보내기
- [ ] 타임라인 뷰 (연대기순)

### 2. UX 개선
- [ ] 드래그 앤 드롭으로 관계 설정
- [ ] 가계도 애니메이션
- [ ] 다크 모드
- [ ] 다국어 지원

### 3. 기술 개선
- [ ] TypeScript 마이그레이션
- [ ] React/Vue 프론트엔드 프레임워크
- [ ] 사용자 인증 시스템
- [ ] 실시간 협업 기능
- [ ] 클라우드 동기화

### 4. 성능 최적화
- [ ] 이미지 최적화 (리사이징, 압축)
- [ ] 가상 스크롤링 (대규모 가계도)
- [ ] 캐싱 전략
- [ ] 번들 최적화

---

## 📚 참고 문서

- [Express.js 공식 문서](https://expressjs.com/)
- [better-sqlite3 문서](https://github.com/WiseLibs/better-sqlite3)
- [SQLite 공식 문서](https://www.sqlite.org/docs.html)
- [MDN Web Docs](https://developer.mozilla.org/)

---

## 👤 개발자 노트

### 개발 과정에서 배운 점
1. **재귀적 데이터 구조**: 가계도는 트리 구조의 전형적인 예
2. **CSS Flexbox**: 복잡한 레이아웃도 Flexbox로 간결하게 구현 가능
3. **SVG vs CSS**: 단순한 선은 CSS로 충분, 복잡한 도형은 SVG
4. **중복 방지**: Set 자료구조의 효과적인 활용
5. **조건부 렌더링**: JavaScript에서 클래스를 동적으로 추가하여 CSS 제어

### 어려웠던 점
1. **재귀 렌더링 디버깅**: 중복 방지 로직 구현
2. **CSS 선 위치 조정**: 다양한 경우의 수 고려
3. **이미지 에러 처리**: 무한 루프 방지

### 만족스러운 점
1. **깔끔한 UI**: 모던하고 직관적인 디자인
2. **반응형 구현**: 모바일에서도 잘 작동
3. **코드 구조**: 모듈화된 설계로 유지보수 용이

---

## 📞 연락처 및 지원

프로젝트 관련 문의사항이 있으시면 이슈를 생성해 주세요.

---

**마지막 업데이트:** 2025년 11월 28일 오전 1:45
**작성자:** AI Assistant (Claude Sonnet 4.5)
**버전:** 1.0.0

